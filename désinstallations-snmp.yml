---
- name: D√©sinstallation compl√®te SNMP (Exporter, snmpd, Prometheus, g√©n√©rateur)
  hosts:
    - grafana
    - itop
    - semaphore
  become: yes

  vars:
    snmp_exporter_user: "snmp_exporter"
    snmp_exporter_install_dir: "/usr/local/snmp_exporter"
    prometheus_config_path: "/etc/prometheus/prometheus.yml"
    snmp_yml_dest: "/etc/snmp_exporter/snmp.yml"
    generator_dir: "/opt/snmp_exporter_generator"
    generator_packages:
      - git
      - make
      - golang-go
      - libsnmp-dev
      - curl

  tasks:

    # SECTION 1: D√©sinstallation du snmp_exporter
    - name: "[Exporter] Stopper et d√©sactiver snmp_exporter"
      systemd:
        name: snmp_exporter
        state: stopped
        enabled: no
      ignore_errors: yes

    - name: "[Exporter] Supprimer le fichier systemd de snmp_exporter"
      file:
        path: /etc/systemd/system/snmp_exporter.service
        state: absent

    - name: "[Exporter] Supprimer le r√©pertoire d‚Äôinstallation"
      file:
        path: "{{ snmp_exporter_install_dir }}"
        state: absent

    - name: "[Exporter] Supprimer les fichiers temporaires"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/snmp_exporter.tar.gz
        - /tmp/snmp_exporter-0.28.0.linux-amd64

    - name: "[Exporter] Supprimer l'utilisateur snmp_exporter"
      user:
        name: "{{ snmp_exporter_user }}"
        state: absent
        remove: yes
      ignore_errors: yes

    # SECTION 2: D√©sinstallation de snmpd (agent)
    - name: "[SNMPD] Attendre la lib√©ration du verrou dpkg"
      shell: |
        while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
          echo "üîí En attente de la lib√©ration du verrou dpkg..."
          sleep 3
        done
      changed_when: false

    - name: "[SNMPD] Stopper et d√©sactiver snmpd"
      systemd:
        name: snmpd
        state: stopped
        enabled: no
      ignore_errors: yes

    - name: "[SNMPD] Supprimer snmpd et ses d√©pendances"
      apt:
        name: snmpd
        state: absent
        purge: yes
        autoremove: yes
        update_cache: yes

    - name: "[SNMPD] Supprimer les fichiers de configuration snmpd"
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /etc/snmp/snmpd.conf
        - /etc/snmp/snmpd.conf.bak
        - /etc/snmp
        - /var/lib/snmp
        - /var/log/snmpd.log

- name: Nettoyage Prometheus sur Grafana
  hosts: grafana
  become: yes
  tasks:
    - name: "[Prometheus] Stopper Prometheus"
      systemd:
        name: prometheus
        state: stopped
      ignore_errors: yes

    - name: "[Prometheus] Restaurer le prometheus.yml d‚Äôorigine s‚Äôil existe"
      copy:
        src: "{{ prometheus_config_path }}.backup"
        dest: "{{ prometheus_config_path }}"
        remote_src: yes
        mode: '0644'
      ignore_errors: yes

    - name: "[Prometheus] Supprimer l‚Äô√©ventuelle sauvegarde restante"
      file:
        path: "{{ prometheus_config_path }}.backup"
        state: absent
      ignore_errors: yes

    - name: "[Prometheus] Red√©marrer Prometheus"
      systemd:
        name: prometheus
        state: started
        enabled: yes
      ignore_errors: yes

- name: Nettoyage du g√©n√©rateur SNMP sur Grafana
  hosts: grafana
  become: yes
  tasks:
    - name: "[G√©n√©rateur] Supprimer le fichier snmp.yml g√©n√©r√©"
      file:
        path: "{{ snmp_yml_dest }}"
        state: absent

    - name: "[G√©n√©rateur] Supprimer le dossier du g√©n√©rateur"
      file:
        path: "{{ generator_dir }}"
        state: absent

    - name: "[G√©n√©rateur] Supprimer les paquets li√©s √† la g√©n√©ration"
      apt:
        name: "{{ generator_packages }}"
        state: absent
        purge: yes
        autoremove: yes
      ignore_errors: yes

- name: V√©rification finale
  hosts: all
  become: yes
  tasks:
    - name: "[V√©rif] Afficher confirmation nettoyage complet"
      debug:
        msg: "‚úÖ Tous les composants SNMP ont √©t√© supprim√©s proprement de la machine."

---
- name: Envoyer les serveurs vers iTop via API REST
  hosts: all
  gather_facts: yes
  vars:
    itop_url: "http://10.0.57.36/web/webservices/rest.php"
    itop_user: "rest_user"
    itop_password: "RestUser@123"
    itop_version: "1.3"
    org_id: 4

  tasks:
    - name: Construire les données serveur
      set_fact:
        server_data: |
          {
            "version": "{{ itop_version }}",
            "operation": "core/create",
            "class": "Server",
            "comment": "Ajout automatique depuis Ansible",
            "fields": {
              "name": "{{ ansible_hostname }}",
              "org_id": "{{ org_id }}",
              "status": "production",
              "os_family": "{{ ansible_os_family }}",
              "os_version": "{{ ansible_distribution }} {{ ansible_distribution_version }}",
              "cpu": "{{ ansible_processor[1] | default('Unknown') }}",
              "ram": "{{ ansible_memtotal_mb }}",
              "description": "Serveur ajouté depuis Ansible via REST API"
            }
          }

    - name: Envoyer les données à iTop via API REST
      uri:
        url: "{{ itop_url }}"
        method: POST
        user: "{{ itop_user }}"
        password: "{{ itop_password }}"
        force_basic_auth: yes
        body_format: form-urlencoded
        body:
          json_data: "{{ server_data | string }}"
        return_content: yes
      register: itop_response

    - name: Afficher la réponse d’iTop
      debug:
        var: itop_response.json

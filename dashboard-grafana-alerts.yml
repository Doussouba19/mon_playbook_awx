---
- name: Créer un dashboard Grafana avec alertes CPU et MySQL
  hosts: grafana
  become: false
  vars:
    grafana_url: "http://10.0.57.35:3000"
    grafana_user: "admin"
    grafana_password: "12345"
    contact_point_uid: "deqpjhe78lkowc"  # celui du contact point que jai creer

  tasks:
    - name: Créer le dashboard avec alertes
      uri:
        url: "{{ grafana_url }}/api/dashboards/db"
        method: POST
        user: "{{ grafana_user }}"
        password: "{{ grafana_password }}"
        force_basic_auth: true
        headers:
          Content-Type: "application/json"
        body_format: json
        body:
          dashboard:
            id: null
            uid: "surveillance-serveur"
            title: "Surveillance Serveur"
            tags: ["system", "alert"]
            timezone: "browser"
            schemaVersion: 37
            version: 1
            panels:
              - type: timeseries
                title: "Charge CPU (1m)"
                datasource: "Prometheus"
                targets:
                  - expr: avg(rate(node_cpu_seconds_total{mode="user"}[1m])) * 100
                    legendFormat: "CPU Usage"
                fieldConfig:
                  defaults:
                    unit: "percent"
                  overrides: []
                gridPos: { x: 0, y: 0, w: 12, h: 8 }
                alert:
                  name: "Alerte CPU Haute"
                  conditions:
                    - evaluator:
                        params: [80]
                        type: gt
                      operator:
                        type: and
                      query:
                        params: ["A", "5m", "now"]
                      reducer:
                        type: avg
                      type: query
                  noDataState: "NoData"
                  execErrState: "Error"
                  for: "2m"
                  annotations: {}
                  isPaused: false
                  notifications:
                    - uid: "{{ contact_point_uid }}"
              - type: timeseries
                title: "MySQL Service Status"
                datasource: "Prometheus"
                targets:
                  - expr: mysql_up
                    legendFormat: "MySQL UP"
                fieldConfig:
                  defaults:
                    unit: "none"
                  overrides: []
                gridPos: { x: 12, y: 0, w: 12, h: 8 }
                alert:
                  name: "Alerte MySQL DOWN"
                  conditions:
                    - evaluator:
                        params: [1]
                        type: lt
                      operator:
                        type: and
                      query:
                        params: ["A", "1m", "now"]
                      reducer:
                        type: last
                      type: query
                  noDataState: "NoData"
                  execErrState: "Error"
                  for: "1m"
                  annotations: {}
                  isPaused: false
                  notifications:
                    - uid: "{{ contact_point_uid }}"
          overwrite: true
        status_code: 200,202
